{% extends 'base.html.twig' %}

{% block title %}{{ is_edit ? 'Modifier' : 'Cr√©er' }} un utilisateur{% endblock %}

{% block stylesheets %}
{{ parent() }}
<style>
    .form-header {
        background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        color: white;
        padding: 1.5rem 0;
        margin-bottom: 2rem;
    }

    .form-header h1 {
        margin: 0;
        font-size: 1.75rem;
        font-weight: 700;
    }

    .form-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .form-card h3 {
        font-size: 1.1rem;
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #e9ecef;
    }

    .roles-group {
        margin-bottom: 0.75rem;
    }

    .roles-group-label {
        font-size: 0.75rem;
        font-weight: 700;
        color: #888;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.5rem;
    }

    .role-checkbox {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.4rem 0.75rem;
        border-radius: 6px;
        margin-bottom: 0.25rem;
        transition: background 0.2s;
    }

    .role-checkbox:hover {
        background: #f8f9fa;
    }

    .role-checkbox label {
        font-size: 0.9rem;
        cursor: pointer;
        flex: 1;
    }

    .role-checkbox .role-desc {
        font-size: 0.75rem;
        color: #888;
    }

    .agencies-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 0.5rem;
    }

    .agency-checkbox {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.4rem 0.6rem;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .agency-checkbox:hover {
        border-color: #2563eb;
        background: #f0f4ff;
    }

    .agency-checkbox input:checked + span {
        font-weight: 700;
        color: #2563eb;
    }

    .agency-checkbox span {
        font-size: 0.85rem;
    }

    .form-card.card-cc-admin h3 { border-bottom-color: #fbbf24; }
    .form-card.card-cc-user  h3 { border-bottom-color: #34d399; }

    .cc-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 0.5rem;
        margin-bottom: 0.5rem;
    }

    .cc-checkbox-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 0.75rem;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.9rem;
    }

    .card-cc-admin .cc-checkbox-item:hover { border-color: #f59e0b; background: #fffbeb; }
    .card-cc-user  .cc-checkbox-item:hover { border-color: #10b981; background: #f0fdf4; }

    .card-cc-admin .cc-checkbox-item input:checked + span { font-weight: 700; color: #d97706; }
    .card-cc-user  .cc-checkbox-item input:checked + span { font-weight: 700; color: #059669; }

    .error-list {
        background: #fef2f2;
        border: 1px solid #fecaca;
        border-radius: 8px;
        padding: 1rem 1.5rem;
        margin-bottom: 1.5rem;
    }

    .error-list ul {
        margin: 0;
        padding-left: 1.25rem;
    }

    .error-list li {
        color: #dc2626;
        font-size: 0.9rem;
    }
</style>
{% endblock %}

{% block body %}
{# Header #}
<div class="form-header">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center">
            <h1>{{ is_edit ? 'Modifier' : 'Cr√©er' }} un utilisateur</h1>
            <a href="{{ path('admin_users') }}" class="btn btn-outline-light btn-sm">‚Üê Retour √† la liste</a>
        </div>
    </div>
</div>

<div class="container" style="max-width: 800px;">
    {# Erreurs #}
    {% if errors|length > 0 %}
    <div class="error-list">
        <strong>Erreurs :</strong>
        <ul>
            {% for error in errors %}
                <li>{{ error }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <form method="post" 
          action="{{ is_edit ? path('admin_users_edit', {id: user.id}) : path('admin_users_new') }}"
          id="userForm">
        
        <input type="hidden" name="_token" 
               value="{{ csrf_token(is_edit ? 'user_edit_' ~ user.id : 'user_new') }}">

        {# ===== Informations personnelles ===== #}
        <div class="form-card">
            <h3>Informations personnelles</h3>
            <div class="row g-3">
                <div class="col-md-6">
                    <label for="prenom" class="form-label">Pr√©nom *</label>
                    <input type="text" class="form-control" id="prenom" name="prenom"
                           value="{{ user ? user.prenom : '' }}" required>
                </div>
                <div class="col-md-6">
                    <label for="nom" class="form-label">Nom *</label>
                    <input type="text" class="form-control" id="nom" name="nom"
                           value="{{ user ? user.nom : '' }}" required>
                </div>
                <div class="col-md-12">
                    <label for="email" class="form-label">Email *</label>
                    <input type="email" class="form-control" id="email" name="email"
                           value="{{ user ? user.email : '' }}" required>
                </div>
                {% if not is_edit %}
                <div class="col-md-12">
                    <label for="password" class="form-label">Mot de passe * <small class="text-muted">(min. 8 caract√®res)</small></label>
                    <input type="password" class="form-control" id="password" name="password"
                           minlength="8" required>
                </div>
                {% endif %}
                <div class="col-md-12">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="is_active" name="is_active" value="1"
                               {{ (user is null or user.active) ? 'checked' : '' }}>
                        <label class="form-check-label" for="is_active">Compte actif</label>
                    </div>
                </div>
            </div>
        </div>

        {# ===== R√¥les ===== #}
        <div class="form-card">
            <h3>R√¥les</h3>
            {% for group_name, group_roles in available_roles %}
            <div class="roles-group">
                <div class="roles-group-label">{{ group_name }}</div>
                {% for role_key, role_label in group_roles %}
                <div class="role-checkbox">
                    <input type="checkbox" 
                           id="role_{{ role_key }}" 
                           name="roles[]" 
                           value="{{ role_key }}"
                           class="form-check-input role-input"
                           data-role="{{ role_key }}"
                           {{ user and role_key in user.roles ? 'checked' : '' }}>
                    <label for="role_{{ role_key }}">
                        {{ role_label }}
                        <span class="role-desc">{{ role_key }}</span>
                    </label>
                </div>
                {% endfor %}
            </div>
            {% endfor %}
        </div>

        {# ===== Agences ===== #}
        <div class="form-card">
            <h3>Agences accessibles</h3>
            <p class="text-muted" style="font-size: 0.85rem;">
                S√©lectionne les agences auxquelles cet utilisateur aura acc√®s.
            </p>
            <div class="agencies-grid">
                {% for agency in agencies %}
                <label class="agency-checkbox">
                    <input type="checkbox" name="agencies[]" value="{{ agency }}"
                           {{ user and user.agencies and agency in user.agencies ? 'checked' : '' }}>
                    <span>{{ agency }}</span>
                </label>
                {% endfor %}
            </div>
            <div class="mt-2">
                <button type="button" class="btn btn-sm btn-outline-secondary" id="selectAllAgencies">
                    Tout s√©lectionner
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary" id="deselectAllAgencies">
                    Tout d√©s√©lectionner
                </button>
            </div>
        </div>

        {# ===== Droits CC Admin (employ√©s SOMAFI g√©rant 1..N contrats cadres) ===== #}
        <div class="form-card card-cc-admin">
            <h3>‚öôÔ∏è Droits CC Admin <small class="fw-normal text-muted" style="font-size:0.8rem;">(employ√© SOMAFI)</small></h3>
            <p class="text-muted" style="font-size: 0.85rem;">
                Coche les contrats cadres sur lesquels cet utilisateur a un acc√®s administrateur (gestion, supervision).
            </p>
            {% if contrats_cadre|length > 0 %}
            <div class="cc-grid" id="ccAdminGrid">
                {% for cc in contrats_cadre %}
                <label class="cc-checkbox-item">
                    <input type="checkbox"
                           class="form-check-input cc-admin-input"
                           name="cc_admin[]"
                           value="{{ cc.id }}"
                           {{ (
                               (cc_admin_ids is defined and cc.id in cc_admin_ids)
                               or
                               (user and user.userContratCadres is defined and user.userContratCadres|filter(ucc => ucc.contratCadre.id == cc.id and ucc.roleType == 'admin')|length > 0)
                           ) ? 'checked' : '' }}>
                    <span>{{ cc.nom }}</span>
                </label>
                {% endfor %}
            </div>
            <div class="mt-2">
                <button type="button" class="btn btn-sm btn-outline-warning" id="selectAllCcAdmin">Tout s√©lectionner</button>
                <button type="button" class="btn btn-sm btn-outline-secondary" id="deselectAllCcAdmin">Tout d√©s√©lectionner</button>
            </div>
            {% else %}
            <p class="text-muted fst-italic mb-0">Aucun contrat cadre disponible.</p>
            {% endif %}
        </div>

        {# ===== Droits CC User (clients externes en lecture) ===== #}
        <div class="form-card card-cc-user">
            <h3>üëÅÔ∏è Droits CC User <small class="fw-normal text-muted" style="font-size:0.8rem;">(client externe, lecture)</small></h3>
            <p class="text-muted" style="font-size: 0.85rem;">
                Coche les contrats cadres auxquels cet utilisateur a acc√®s en lecture (portail client).
                Un CC d√©j√† coch√© en Admin ne peut pas √™tre coch√© en User.
            </p>
            {% if contrats_cadre|length > 0 %}
            <div class="cc-grid" id="ccUserGrid">
                {% for cc in contrats_cadre %}
                <label class="cc-checkbox-item" id="ccUserLabel_{{ cc.id }}">
                    <input type="checkbox"
                           class="form-check-input cc-user-input"
                           name="cc_user[]"
                           value="{{ cc.id }}"
                           data-cc-id="{{ cc.id }}"
                           {{ (
                               (cc_user_ids is defined and cc.id in cc_user_ids)
                               or
                               (user and user.userContratCadres is defined and user.userContratCadres|filter(ucc => ucc.contratCadre.id == cc.id and ucc.roleType == 'user')|length > 0)
                           ) ? 'checked' : '' }}>
                    <span>{{ cc.nom }}</span>
                </label>
                {% endfor %}
            </div>
            <div class="mt-2">
                <button type="button" class="btn btn-sm btn-outline-success" id="selectAllCcUser">Tout s√©lectionner</button>
                <button type="button" class="btn btn-sm btn-outline-secondary" id="deselectAllCcUser">Tout d√©s√©lectionner</button>
            </div>
            {% else %}
            <p class="text-muted fst-italic mb-0">Aucun contrat cadre disponible.</p>
            {% endif %}
        </div>

        {# ===== Boutons ===== #}
        <div class="d-flex justify-content-between align-items-center mb-4">
            <a href="{{ path('admin_users') }}" class="btn btn-outline-secondary">Annuler</a>
            <button type="submit" class="btn btn-primary btn-lg">
                {{ is_edit ? 'üíæ Enregistrer les modifications' : "‚úÖ Cr√©er l'utilisateur" }}
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script>
document.addEventListener('turbo:load', function () {

    // ---------- Agences ----------
    const selectAllAgencies   = document.getElementById('selectAllAgencies');
    const deselectAllAgencies = document.getElementById('deselectAllAgencies');
    const agencyCheckboxes    = document.querySelectorAll('input[name="agencies[]"]');

    if (selectAllAgencies) {
        selectAllAgencies.addEventListener('click',   () => agencyCheckboxes.forEach(cb => cb.checked = true));
        deselectAllAgencies.addEventListener('click', () => agencyCheckboxes.forEach(cb => cb.checked = false));
    }

    // ---------- CC ----------
    const ccAdminInputs      = document.querySelectorAll('.cc-admin-input');
    const ccUserInputs       = document.querySelectorAll('.cc-user-input');
    const selectAllCcAdmin   = document.getElementById('selectAllCcAdmin');
    const deselectAllCcAdmin = document.getElementById('deselectAllCcAdmin');
    const selectAllCcUser    = document.getElementById('selectAllCcUser');
    const deselectAllCcUser  = document.getElementById('deselectAllCcUser');

    /**
     * R√®gle d'exclusivit√© : si un CC est coch√© en Admin,
     * il est d√©sactiv√© (et d√©coch√©) c√¥t√© User.
     */
    function syncCcExclusivity() {
        const adminCheckedIds = new Set(
            Array.from(ccAdminInputs)
                .filter(i => i.checked)
                .map(i => i.value)
        );

        ccUserInputs.forEach(function (input) {
            const ccId = input.dataset.ccId;
            const label = document.getElementById('ccUserLabel_' + ccId);
            if (adminCheckedIds.has(ccId)) {
                input.checked  = false;
                input.disabled = true;
                if (label) label.style.opacity = '0.4';
            } else {
                input.disabled = false;
                if (label) label.style.opacity = '1';
            }
        });
    }

    ccAdminInputs.forEach(i => i.addEventListener('change', syncCcExclusivity));
    syncCcExclusivity(); // √©tat initial

    if (selectAllCcAdmin) {
        selectAllCcAdmin.addEventListener('click', function () {
            ccAdminInputs.forEach(cb => cb.checked = true);
            syncCcExclusivity();
        });
        deselectAllCcAdmin.addEventListener('click', function () {
            ccAdminInputs.forEach(cb => cb.checked = false);
            syncCcExclusivity();
        });
    }

    if (selectAllCcUser) {
        selectAllCcUser.addEventListener('click',   () => ccUserInputs.forEach(cb => { if (!cb.disabled) cb.checked = true; }));
        deselectAllCcUser.addEventListener('click', () => ccUserInputs.forEach(cb => { if (!cb.disabled) cb.checked = false; }));
    }
});
</script>
{% endblock %}
