{# templates/contrat_entretien/_form_contrat.html.twig #}

{# === SECTION SÉLECTION CLIENT === #}
<div class="card mb-4" id="client-selection-card">
    <div class="card-header bg-warning text-dark">
        <i class="bi bi-person-check"></i> Client rattaché au contrat
    </div>
    <div class="card-body">

        {# Bandeau info si client déjà sélectionné #}
        <div id="client-selected-banner" class="alert alert-info d-flex align-items-center {% if not clientInfo %}d-none{% endif %}">
            <i class="bi bi-person-badge me-2 fs-4"></i>
            <div class="flex-grow-1">
                <strong>Client :</strong>
                <span id="client-selected-name">{{ clientInfo.raison_sociale ?? '' }}</span>
                <span id="client-selected-location">
                    {% if clientInfo.ville is defined and clientInfo.ville %} — {{ clientInfo.ville }}{% endif %}
                    {% if clientInfo.code_postal is defined and clientInfo.code_postal %} ({{ clientInfo.code_postal }}){% endif %}
                </span>
                <br>
                <small class="text-muted">
                    id_contact: <span id="client-selected-id-contact">{{ dto.idContact ?? '' }}</span>
                    | contact_id: <span id="client-selected-contact-id">{{ dto.contactId ?? '' }}</span>
                </small>
            </div>
            <button type="button" class="btn btn-sm btn-outline-secondary ms-3" id="btn-change-client" title="Changer de client">
                <i class="bi bi-arrow-repeat"></i> Changer
            </button>
        </div>

        {# Zone de recherche (visible si pas de client sélectionné) #}
        <div id="client-search-zone" class="{% if clientInfo %}d-none{% endif %}">
            <label class="form-label fw-bold">Rechercher un client existant</label>
            <div class="position-relative">
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input
                        type="text"
                        id="client-search-input"
                        class="form-control"
                        placeholder="Tapez au moins 2 caractères (raison sociale)..."
                        autocomplete="off"
                    >
                </div>
                {# Dropdown résultats #}
                <div id="client-search-results"
                     class="list-group position-absolute w-100 shadow-sm d-none"
                     style="z-index: 1050; max-height: 300px; overflow-y: auto;">
                </div>
            </div>
            <div class="mt-2">
                <small class="text-muted">
                    Ou
                    <a href="{{ path('app_contrat_entretien_create_client', {agencyCode: agencyCode}) }}">
                        <i class="bi bi-person-plus"></i> créer un nouveau client
                    </a>
                </small>
            </div>
        </div>

        {# Message de validation si pas de client #}
        <div id="client-validation-error" class="invalid-feedback d-none">
            Veuillez sélectionner un client avant de soumettre le formulaire.
        </div>
    </div>
</div>

{{ form_start(form, {'attr': {'novalidate': 'novalidate', 'enctype': 'multipart/form-data'}}) }}

{# Hidden fields #}
{{ form_widget(form.idContact) }}
{{ form_widget(form.contactId) }}

{# ═══════════════════ INFORMATIONS GÉNÉRALES ═══════════════════ #}
<div class="card mb-4">
    <div class="card-header bg-primary text-white">
        <i class="bi bi-file-earmark-text"></i> Informations générales
    </div>
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-4">
                {{ form_row(form.numeroContrat) }}
            </div>
            <div class="col-md-4">
                {{ form_row(form.dateSignature) }}
            </div>
            <div class="col-md-4">
                {{ form_row(form.duree) }}
            </div>
        </div>
        <div class="row g-3 mt-1">
            <div class="col-md-4">
                {{ form_row(form.dateDebutContrat) }}
            </div>
            <div class="col-md-4">
                {{ form_row(form.dateFinContrat) }}
            </div>
            <div class="col-md-4 d-flex align-items-end pb-3">
                {{ form_row(form.isTaciteReconduction) }}
            </div>
        </div>
    </div>
</div>

{# ═══════════════════ FINANCIER ═══════════════════ #}
<div class="card mb-4">
    <div class="card-header bg-success text-white">
        <i class="bi bi-currency-euro"></i> Financier
    </div>
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-4">
                {{ form_row(form.valorisation) }}
            </div>
            <div class="col-md-4">
                {{ form_row(form.modeRevalorisation) }}
            </div>
            <div class="col-md-4">
                {{ form_row(form.tauxRevalorisation) }}
            </div>
        </div>
        <div class="row g-3 mt-1">
            <div class="col-md-4">
                {{ form_row(form.montantAnnuelHt) }}
            </div>
        </div>

        <hr>
        <h6 class="text-muted mb-3">Montants par type de visite</h6>
        <div class="row g-3">
            <div class="col-md-4 col-lg-2">
                {{ form_row(form.montantVisiteCEA) }}
            </div>
            <div class="col-md-4 col-lg-2">
                {{ form_row(form.montantVisiteCE1) }}
            </div>
            <div class="col-md-4 col-lg-2">
                {{ form_row(form.montantVisiteCE2) }}
            </div>
            <div class="col-md-4 col-lg-2">
                {{ form_row(form.montantVisiteCE3) }}
            </div>
            <div class="col-md-4 col-lg-2">
                {{ form_row(form.montantVisiteCE4) }}
            </div>
        </div>
    </div>
</div>

{# ═══════════════════ PARC & PLANIFICATION ═══════════════════ #}
<div class="card mb-4">
    <div class="card-header bg-info text-white">
        <i class="bi bi-tools"></i> Parc & Planification
    </div>
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-3">
                {{ form_row(form.nombreEquipement) }}
            </div>
            <div class="col-md-3">
                {{ form_row(form.nombreVisite) }}
            </div>
            <div class="col-md-3">
                {{ form_row(form.datePrevisionnelle1) }}
            </div>
            <div class="col-md-3">
                {{ form_row(form.datePrevisionnelle2) }}
            </div>
        </div>
    </div>
</div>

{# ═══════════════════ DOCUMENTS ═══════════════════ #}
<div class="card mb-4">
    <div class="card-header bg-warning text-dark">
        <i class="bi bi-file-earmark-pdf"></i> Documents
    </div>
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-6">
                {{ form_row(form.contratPdfFile) }}
                <small class="form-text text-muted">
                    Format PDF uniquement — 10 Mo max. Le PDF pourra aussi être ajouté plus tard.
                </small>
            </div>
        </div>
    </div>
</div>

{# ═══════════════════ NOTES ═══════════════════ #}
<div class="card mb-4">
    <div class="card-header bg-secondary text-white">
        <i class="bi bi-journal-text"></i> Notes
    </div>
    <div class="card-body">
        {{ form_row(form.notes) }}
    </div>
</div>

{# ═══════════════════ BOUTONS ═══════════════════ #}
<div class="d-flex justify-content-between mt-4 mb-5">
    <a href="{{ path('app_contrat_entretien_index', {agencyCode: agencyCode}) }}" 
       class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Retour à la liste
    </a>
    <div>
        <button type="submit" name="action" value="save_and_show" class="btn btn-primary">
            <i class="bi bi-check-lg"></i> Enregistrer le contrat
        </button>
        <button type="submit" name="action" value="save_and_equipements" class="btn btn-success ms-2">
            <i class="bi bi-tools"></i> Enregistrer et gérer les équipements
        </button>
    </div>
</div>

{{ form_end(form) }}